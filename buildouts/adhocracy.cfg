##############################################################################  
# Buildout to install adhocracy
#
# requires:
#     - libjpeg, libpng dev
#     - libsqlite3 dev
#
##############################################################################

[buildout]           
# workaround to make aggregating supervisor:programms work 
# to use this buildout standalone you need to include base.cfg
#extends = base.cfg
eggs += 
    pysqlite
    WSGIRewrite
    repoze.xmliter
    PILwoTK == 1.1.6.4
    adhocracy 
    BeautifulSoup
    fanstatic
    js.jquery_joyride
    Paste
    PasteDeploy
# checkout adhocracy packages to ./src
auto-checkout = *
# parts in this buildout file to be installed    
parts +=
    paster
    adhocpy
    adhocracy_conf
    omelette
    supervisor
    adhocracy_setup

##############################################################################  
# System settings
##############################################################################  
 
[domains]
main = adhocracy.lan

[ports]
main = 5001
supervisor = 5010
 
##############################################################################  
# Adhocracy settings
##############################################################################  

[adhocracy]
#start adhocracy in debug mode
debug = False
#TODO use geo features (You also need to include postgres_with_postgis instead of postgres)
geo = True
# theme adhocracy with diazo and merge a wordpress blog.
hemed = False 
 
protocol = http
host = 127.0.0.1
#Replace this with a randomly generated hash value:
secret = DGK23234324234019357FFFFFFsecret
#Adhocracy email from:
email.from = mail@adhocracy.cc
#Error emails:
email.to = 
smtp_server = localhost
smtp_port = 25
#Database connection
sqlalchemy.url = sqlite:///${buildout:directory}/var/development.db
#sqlalchemy.url = postgres://nutzer:passwort@localhost/20101128 
#Site name for all instances, part of the html <title>, notification E-Mails etc
site.name = Adhocracy
language = de_DE

[twitter]
username = 
key = 
secret = 
consumer_key = 
consumer_secret = 
#Full path to a twitter profile, e.g. http://twitter.com/liqd_de
profile_url =
 
##############################################################################  
# Versions and code
##############################################################################

[adhocracy_code]
diazo_theme_rules_dir =

[sources]
adhocracy = git https://github.com/liqd/adhocracy branch=master 
#adhocracy = git https://github.com/liqd/adhocracy rev=HEAD 
js.socialshareprivacy = hg https://bitbucket.org/csenger/js.socialshareprivacy
js.jquery_joyride = hg https://bitbucket.org/csenger/js.jquery_joyride


##############################################################################  
# Setup adhocracy 
##############################################################################

#install paster to set up adhocracy
[paster]
recipe = zc.recipe.egg
eggs =
    ${buildout:eggs}
    PasteScript
    PasteDeploy
entry-points = paster=paste.script.command:run 
initialization =
    import paste.script.command
    paste.script.command.system_plugins.append('adhocracy') 

# python with all required eggs 
[adhocpy]   
recipe = zc.recipe.egg
eggs =  ${buildout:eggs}
interpreter = adhocpy
scripts = adhocpy

# unified directory structure of installed eggs
[omelette]
recipe = collective.recipe.omelette
eggs = 
    ${buildout:eggs} 
    supervisor 

# generate the adhocracy config file
[adhocracy_conf] 
recipe = collective.recipe.template[genshi]:genshi
input = ${buildout:directory}/etc/adhocracy.ini.in
output = ${buildout:directory}/etc/adhocracy.ini

#set up adhocracy 
[adhocracy_setup] 
recipe = plone.recipe.command
command = 
    chmod -R g+rw var/data
    ln -s parts/omelette installed_eggs
    echo "\n######################################################"
    echo "\nMANUEL STEP to initialize the adhocracy database:\n"
    echo "start supervisord to start your databaseserver: $ bin/supervisord\n"
    echo "run setup-app: $ bin/paster setup-app ${buildout:directory}/etc/adhocracy.ini --name=content\n"
    echo "restart supervisor: $ bin/supervisorct reload\n"
    echo "check that every service is running: bin/supervisorctl status\n"
    echo "note the supervisord config: parts/supervisor/supervisor.conf\n"
    echo "######################################################"
 
##############################################################################  
# Set up supervisor to run it all
##############################################################################

[supervisor]
recipe = collective.recipe.supervisor
port = 127.0.0.1:${ports:supervisor}
programs +=
   40 adhocracy_background (environment=${supervisor:environment}) ${buildout:directory}/bin/paster [--plugin=adhocracy background -c ${buildout:directory}/etc/adhocracy.ini]
   45 adhocracy (environment=${supervisor:environment}) ${buildout:directory}/bin/paster [serve ${buildout:directory}/etc/adhocracy.ini] 

